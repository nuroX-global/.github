---
name: Auto-Validate Action

on:
  push:
    branches: [main, develop, master]
    paths:
      - 'action.yml'
      - 'action.yaml'
      - 'README.md'
      - 'LICENSE'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop, master]
    paths:
      - 'action.yml'
      - 'action.yaml'
      - 'README.md'
      - 'LICENSE'
      - '.github/workflows/**'

jobs:
  auto-validate:
    name: nuroX Auto-Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect and validate GitHub Action
        id: validate
        uses: nuroX-global/nurox-github-action-validator
        with:
          # Auto-detection logic:
          # - Only runs validation if repo name contains "action" AND action.yml exists
          # - Skips validation for non-action repositories (no interference)
          # - Enforces nuroX standards for detected action repositories
          strict-mode: true
          nurox-standards: true
          check-readme: true
          check-license: true
          check-security: true
          security-minimum: 80

      - name: Handle validation failures
        if: steps.validate.outputs.validation-result == 'fail'
        run: |
          echo "::error title=Action Validation Failed::This GitHub Action does not meet nuroX standards and cannot be merged until issues are resolved."
          echo ""
          echo "## ❌ Validation Failed - Action Required"
          echo "**Issues Found**: ${{ steps.validate.outputs.issues-count }}"
          echo "**Security Score**: ${{ steps.validate.outputs.security-score }}/100 (minimum required: 70)"
          echo ""
          echo "### 🔧 How to Fix:"
          echo "1. Review the detailed validation report in the step summary above"
          echo "2. Address all identified issues in your action.yml, README.md, and LICENSE files"
          echo "3. Ensure your action meets nuroX standards:"
          echo "   - Author field must be 'nuroX Global'"
          echo "   - Action name should start with 'Setup', 'nuroX', or 'CICD'"
          echo "   - Description must be at least 20 characters and mention 'nuroX'"
          echo "   - Include proper branding section"
          echo "4. Run validation locally: 'cd nurox-github-action-validator && bash test-validator.sh'"
          echo "5. Commit your fixes and push to trigger re-validation"
          echo ""
          echo "### 📚 Resources:"
          echo "- [nuroX Action Standards](https://wiki.nurox.ai/nurox-github-actions-standards.html)"
          echo "- [GitHub Action Best Practices](https://docs.github.com/en/actions/creating-actions/about-custom-actions)"
          echo "- [nuroX Validator Documentation](https://github.com/nuroX-global/cicd-actions/tree/main/nurox-github-action-validator)"

      - name: Block PR on validation failure
        if: github.event_name == 'pull_request' && steps.validate.outputs.validation-result == 'fail'
        run: |
          echo "::error::PR blocked due to action validation failures. Please fix the issues and try again."
          exit 1

      - name: Notify on validation success
        if: steps.validate.outputs.validation-result == 'pass'
        run: |
          echo "::notice title=Action Validation Passed::✅ This GitHub Action meets all nuroX standards!"
          echo "Security Score: ${{ steps.validate.outputs.security-score }}/100"

      - name: Report validation results
        if: always()
        run: |
          echo "## 🎯 nuroX Organization Auto-Validation" >> $GITHUB_STEP_SUMMARY
          echo "=========================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: Organization default workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show results if validation ran
          if [ "${{ steps.validate.outputs.validation-result }}" != "" ]; then
            echo "**Validation Result**: ${{ steps.validate.outputs.validation-result }}" >> $GITHUB_STEP_SUMMARY
            echo "**Action Type**: ${{ steps.validate.outputs.action-type }}" >> $GITHUB_STEP_SUMMARY  
            echo "**Security Score**: ${{ steps.validate.outputs.security-score }}/100" >> $GITHUB_STEP_SUMMARY
            echo "**Issues Found**: ${{ steps.validate.outputs.issues-count }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.validate.outputs.validation-result }}" = "pass" ]; then
              echo "🎉 **Validation passed!** This GitHub Action meets nuroX standards." >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ **Validation failed.** Please review and address the issues to ensure compliance with nuroX standards." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ **Auto-validation skipped** - Repository not detected as a GitHub Action." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Detection criteria**:" >> $GITHUB_STEP_SUMMARY
            echo "- Repository name contains 'action'" >> $GITHUB_STEP_SUMMARY
            echo "- Action file (action.yml or action.yaml) exists in repository root" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "If this repository should be validated as a GitHub Action, ensure it meets the above criteria." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by [nuroX GitHub Action Validator](https://github.com/nuroX-global/cicd-actions/tree/main/nurox-github-action-validator)*" >> $GITHUB_STEP_SUMMARY
